<!DOCTYPE html>
<html>
<head>
  <title>PharmaFlow ERP - Staff</title>
  <link rel="stylesheet" href="style.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>

<div class="layout">

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="brand">PharmaFlow</div>
    <nav>
      <a class="active" onclick="showTab('medicine')">Dashboard</a>
      <a onclick="showTab('attendance')">Attendance</a>
      <a onclick="showTab('profile')">My Profile</a>
      <a href="billing.html">Billing</a>
      <a href="index.html" onclick="logout();return false;">Logout</a>
    </nav>
  </aside>

  <!-- MAIN -->
  <main class="main">

    <!-- HEADER -->
    <header class="topbar">
      <div>
        <h2 id="pageTitle">ðŸ“¦ Staff Dashboard</h2>
        <p class="subtext" id="pageSubtitle">Manage medicines, attendance & billing</p>
      </div>
      <div class="user-card">
        <span id="staffName">ðŸ‘¤ Staff Account</span>
      </div>
    </header>

    <!-- TABS -->
    <div id="tabs" style="margin-bottom:20px; border-bottom:1px solid #e5e7eb; display:flex; gap:20px;">
      <button onclick="showTab('medicine')" class="tab-btn active">Medicine Locator</button>
      <button onclick="showTab('attendance')" class="tab-btn">Attendance</button>
      <button onclick="showTab('profile')" class="tab-btn">Profile</button>
    </div>

    <!-- MEDICINE TAB -->
    <div id="medicineTab" class="tab-content">
      <!-- KPI -->
      <section class="kpi-grid">
        <div class="kpi-card">
          <span>Total Medicines</span>
          <h3 id="totalMed">0</h3>
        </div>
        <div class="kpi-card">
          <span>Total Stock Units</span>
          <h3 id="totalStock">0</h3>
        </div>
      </section>

      <!-- CONTENT -->
      <section class="content-grid">

        <!-- SEARCH PANEL -->
        <div class="panel">
          <h3>Medicine Locator</h3>

          <div class="search-box">
            <input id="search" placeholder="Enter medicine name">
            <button id="searchBtn">Locate</button>
          </div>

          <div id="result" class="result-card"></div>
        </div>

        <!-- RACK MAP -->
        <div class="panel">
          <h3>Rack Layout</h3>

          <div class="rack">

            <!-- Auto 4x4 -->
            <script>
              for(let r=1;r<=4;r++){
                for(let s=1;s<=4;s++){
                  document.write(`<div id="R${r}S${s}" class="slot">R${r}-S${s}</div>`);
                }
              }
            </script>

          </div>

          <button class="secondary-btn" onclick="checkStock()">Check Low Stock</button>
          <p id="alert"></p>
        </div>

      </section>
    </div>

    <!-- ATTENDANCE TAB -->
    <div id="attendanceTab" class="tab-content" style="display:none;">
      <div class="panel">
        <h3>Daily Attendance</h3>
        <div style="margin:20px 0;">
          <button onclick="markAttendance('present')" class="primary-btn" style="margin-right:10px;">âœ“ Mark Present</button>
          <button onclick="markAttendance('absent')" class="secondary-btn" style="margin-right:10px;">âœ— Mark Absent</button>
          <button onclick="checkOut()" class="secondary-btn">Check Out</button>
        </div>
        <p id="attendanceMsg"></p>
      </div>

      <div class="panel">
        <h3>Attendance History (Last 30 days)</h3>
        <div id="attendanceList" style="max-height:400px; overflow-y:auto;"></div>
      </div>
    </div>

    <!-- PROFILE TAB -->
    <div id="profileTab" class="tab-content" style="display:none;">
      <div class="panel">
        <h3>My Profile</h3>
        <div style="padding:20px;">
          <div style="margin-bottom:15px;">
            <label>Name:</label>
            <input id="profileName" placeholder="Full name" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:5px;">
          </div>
          <div style="margin-bottom:15px;">
            <label>Email:</label>
            <input id="profileEmail" placeholder="Email address" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:5px;">
          </div>
          <div style="margin-bottom:15px;">
            <label>Phone:</label>
            <input id="profilePhone" placeholder="Phone number" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:5px;">
          </div>
          <button onclick="updateProfile()" class="primary-btn">Save Changes</button>
          <p id="profileMsg"></p>
        </div>
      </div>
    </div>

  </main>
</div>

<script src="script.js"></script>

<script>
let currentUser = null;

document.addEventListener("DOMContentLoaded", () => {
  currentUser = verifyRole("staff");
  if (!currentUser) return;
  
  document.getElementById("staffName").innerText = currentUser.name || "Staff";
  loadStats();
  loadAttendance();
  loadProfile();
  
  document.getElementById("searchBtn").addEventListener("click", searchMed);
  const searchInput = document.getElementById("search");
  if (searchInput) {
    searchInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") searchMed();
    });
  }
});

function showTab(tab) {
  // Hide all tabs
  document.getElementById("medicineTab").style.display = "none";
  document.getElementById("attendanceTab").style.display = "none";
  document.getElementById("profileTab").style.display = "none";
  
  // Show selected tab
  document.getElementById(tab + "Tab").style.display = "block";
  
  // Update tab buttons
  const btns = document.querySelectorAll(".tab-btn");
  btns.forEach(b => b.classList.remove("active"));
  event.target.classList.add("active");
}

async function loadStats(){
  try {
    const r = await fetch("/analytics");
    const data = await r.json();
    document.getElementById("totalMed").innerText = data.totalMedicines || 0;
    document.getElementById("totalStock").innerText = data.totalStock || 0;
  } catch (err) {
    console.error("Error loading stats", err);
  }
}

async function loadProfile() {
  if (!currentUser) return;
  try {
    const res = await fetch(`/staff/${currentUser._id}/profile`);
    const data = await res.json();
    document.getElementById("profileName").value = data.name || "";
    document.getElementById("profileEmail").value = data.email || "";
    document.getElementById("profilePhone").value = data.phone || "";
  } catch (err) {
    console.error("Error loading profile", err);
  }
}

async function updateProfile() {
  if (!currentUser) return;
  const name = document.getElementById("profileName").value;
  const email = document.getElementById("profileEmail").value;
  const phone = document.getElementById("profilePhone").value;
  const msg = document.getElementById("profileMsg");
  
  try {
    const res = await fetch(`/staff/${currentUser._id}/profile`, {
      method: "PUT",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ name, email, phone })
    });
    const data = await res.json();
    msg.innerText = "âœ“ Profile updated successfully";
    currentUser = data;
    sessionStorage.setItem("user", JSON.stringify(data));
  } catch (err) {
    msg.innerText = "âœ— Failed to update profile";
  }
}

async function markAttendance(status) {
  if (!currentUser) return;
  const msg = document.getElementById("attendanceMsg");
  
  try {
    const res = await fetch("/attendance/checkin", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({
        user_id: currentUser._id,
        username: currentUser.username,
        status: status
      })
    });
    const data = await res.json();
    msg.innerText = `âœ“ Marked as ${status}`;
    loadAttendance();
  } catch (err) {
    msg.innerText = "âœ— Failed to mark attendance";
  }
}

async function checkOut() {
  if (!currentUser) return;
  const msg = document.getElementById("attendanceMsg");
  
  try {
    const res = await fetch("/attendance/checkout", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ user_id: currentUser._id })
    });
    const data = await res.json();
    msg.innerText = "âœ“ Checked out successfully";
    loadAttendance();
  } catch (err) {
    msg.innerText = "âœ— Failed to check out";
  }
}

async function loadAttendance() {
  if (!currentUser) return;
  
  try {
    const res = await fetch(`/attendance/${currentUser._id}`);
    const records = await res.json();
    const list = document.getElementById("attendanceList");
    
    if (records.length === 0) {
      list.innerHTML = "<p>No attendance records</p>";
      return;
    }
    
    let html = "<table style='width:100%; border-collapse:collapse;'>";
    html += "<tr style='background:#f3f4f6; font-weight:bold;'><th style='padding:10px; text-align:left; border-bottom:1px solid #ddd;'>Date</th><th style='padding:10px; text-align:left; border-bottom:1px solid #ddd;'>Status</th><th style='padding:10px; text-align:left; border-bottom:1px solid #ddd;'>Check In</th><th style='padding:10px; text-align:left; border-bottom:1px solid #ddd;'>Check Out</th></tr>";
    
    records.forEach(r => {
      const date = new Date(r.date).toLocaleDateString();
      const checkIn = r.check_in ? new Date(r.check_in).toLocaleTimeString() : "-";
      const checkOut = r.check_out ? new Date(r.check_out).toLocaleTimeString() : "-";
      const statusColor = r.status === "present" ? "#10b981" : (r.status === "absent" ? "#ef4444" : "#f59e0b");
      
      html += `<tr style='border-bottom:1px solid #ddd;'>
        <td style='padding:10px;'>${date}</td>
        <td style='padding:10px; color:${statusColor}; font-weight:bold;'>${r.status}</td>
        <td style='padding:10px;'>${checkIn}</td>
        <td style='padding:10px;'>${checkOut}</td>
      </tr>`;
    });
    
    html += "</table>";
    list.innerHTML = html;
  } catch (err) {
    console.error("Error loading attendance", err);
    document.getElementById("attendanceList").innerHTML = "<p>Failed to load attendance records</p>";
  }
}
</script>

</body>
</html>
